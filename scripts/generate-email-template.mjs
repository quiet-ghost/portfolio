#!/usr/bin/env node

/**
 * Build script to pre-render the AutoReplyTemplate to static HTML
 * This allows us to use React Email components while keeping edge runtime compatibility
 */

import { render } from '@react-email/render';
import { writeFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import React from 'react';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

console.log('üìß Generating email template...');

// Manually create the template structure since we can't import .tsx
// This mirrors the AutoReplyTemplate.tsx component
const { Html, Head, Body, Container, Heading, Text, Hr } = await import('@react-email/components');

const AutoReplyTemplate = ({ name, message }) => {
  return React.createElement(Html, null,
    React.createElement(Head, null),
    React.createElement(Body, {
      style: {
        backgroundColor: "#f4f4f4",
        fontFamily: "Arial, sans-serif",
        color: "#333",
      }
    },
      React.createElement(Container, {
        style: {
          backgroundColor: "#ffffff",
          padding: "20px",
          margin: "20px auto",
          maxWidth: "600px",
          borderRadius: "8px",
        }
      },
        React.createElement(Heading, {
          style: { color: "#0e7490", fontSize: "24px" }
        }, `Thank You for Reaching Out, ${name}!`),
        React.createElement(Text, {
          style: { fontSize: "16px", lineHeight: "1.5" }
        }, "I've received your message and will get back to you as soon as possible. I appreciate your interest and look forward to connecting!"),
        React.createElement(Hr, {
          style: { borderColor: "#e5e7eb", margin: "20px 0" }
        }),
        React.createElement(Text, {
          style: { fontSize: "14px", color: "#4b5563" }
        },
          React.createElement("strong", null, "Your Message:"),
          React.createElement("br", null),
          message
        ),
        React.createElement(Text, {
          style: { fontSize: "14px", marginTop: "20px" }
        },
          "Best regards,",
          React.createElement("br", null),
          "Kevin C. Sclafani (quietghost)",
          React.createElement("br", null)
        )
      )
    )
  );
};

try {
  // Render template with placeholders
  const html = await render(
    React.createElement(AutoReplyTemplate, { 
      name: '{{NAME}}', 
      message: '{{MESSAGE}}' 
    }),
    {
      pretty: true,
    }
  );

  // Create TypeScript file with the template as a constant
  const tsContent = `/**
 * Auto-generated email template
 * Generated at build time from AutoReplyTemplate component
 * DO NOT EDIT THIS FILE MANUALLY - Edit AutoReplyTemplate.tsx and regenerate
 */

export const AUTO_REPLY_TEMPLATE = \`${html.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`;

/**
 * Replace template placeholders with actual values
 */
export function renderAutoReplyEmail(name: string, message: string): string {
  return AUTO_REPLY_TEMPLATE
    .replace(/{{NAME}}/g, escapeHtml(name))
    .replace(/{{MESSAGE}}/g, escapeHtml(message).replace(/\\n/g, '<br>'));
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text: string): string {
  const map: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
  };
  return text.replace(/[&<>"']/g, (char) => map[char] || char);
}
`;

  // Write to lib directory
  const outputPath = join(__dirname, '../lib/email-template.ts');
  writeFileSync(outputPath, tsContent, 'utf-8');

  console.log('‚úÖ Email template generated successfully!');
  console.log('üìÑ Output:', outputPath);
} catch (error) {
  console.error('‚ùå Error generating email template:', error);
  process.exit(1);
}
